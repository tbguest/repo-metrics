import Head from "next/head";
import { useState } from "react";
import { AddRepoForm } from "../components/AddRepoForm";
import { CardGrid } from "../components/CardGrid";
import ClientOnly from "../components/ClientOnly";
import clientPromise from "../lib/mongodb";
import { AllRepos, Repo } from "../models";
import styles from "../styles/Home.module.css";
import { GetServerSideProps } from "next";
import { InferGetServerSidePropsType } from "next";

import { ApolloProvider } from "@apollo/client";
import { getApolloClient } from "../apollo-client";

const client = getApolloClient();

console.log("client", client);

type PageProps = {
  _id: String;
  owner: String;
  repo: String;
  node_id: String;
};

// {"_id":{"$oid":"62c1903cb3c424022642c756"},"owner":"ethereum","repo":"go-ethereum","node_id":"MDEwOlJlcG9zaXRvcnkxNTQ1MjkxOQ=="}

// const Home = ({ repos }: PageProps[]) => {
const Home = ({
  repos,
}: InferGetServerSidePropsType<typeof getServerSideProps>) => {
  const [repoList, setRepoList] = useState(repos);
  const openList = repos.map(() => false);
  const [open, setOpen] = useState(openList);

  // const ids = repos.map((item: any) => item.node_id);

  // toggle the plot state boolean by index
  const handlePlotClick = (i: number) => {
    const list = [...open];
    list[i] = !list[i];
    setOpen(list);
  };

  return (
    <ApolloProvider client={client}>
      <div className={styles.container}>
        <Head>
          <title>Create Next App</title>
          <meta name="description" content="Generated by create next app" />
          <link rel="icon" href="/favicon.ico" />
        </Head>
        <main className={styles.main}>
          <>
            <h1>GitHub projects by development effort</h1>
            <p>
              Disclaimer: The merit of a project cannot be judged solely on the
              metrics shown here. Use your judgement.
            </p>
            <AddRepoForm repoList={repoList} setRepoList={setRepoList} />
            <ClientOnly>
              {/* <CardGrid ids={ids} open={open} onClick={handlePlotClick} /> */}
              <CardGrid
                repoList={repoList}
                open={open}
                onClick={handlePlotClick}
              />
            </ClientOnly>
          </>
        </main>
      </div>
    </ApolloProvider>
  );
};

export default Home;

// export async function getServerSideProps() {
export const getServerSideProps: GetServerSideProps = async (context) => {
  // const client = getApolloClient();

  const dbClient = await clientPromise;
  const db = dbClient.db(process.env.MONGODB_DB);
  const response = await db
    .collection("repositories")
    .find({})
    .limit(20)
    .toArray();

  const ids = response.map((item) => item.node_id);

  // const nodes = data.nodes;
  const repos = JSON.parse(JSON.stringify(response));

  console.log("repos123", repos);

  return {
    props: {
      // nodes,
      // repos: repos,
      repos,
    },
  };
};
